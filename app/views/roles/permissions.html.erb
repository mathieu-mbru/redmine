<%= title [l(:label_role_plural), roles_path], l(:label_permissions_report) %>

<div class="hide-when-print">
  <fieldset id="filters" class="collapsible collapsed">
    <legend onclick="toggleFieldset(this);" class="icon icon-collapsed"><%= l(:label_filter_plural) %></legend>
    <div style="display: none;">
      <%= form_tag({}, :method => :get) do %>
        <fieldset>
          <legend><%= toggle_checkboxes_link('#filters input[type=checkbox]:enabled') %></legend>
          <% Role.sorted.to_a.each do |role| %>
            <label>
              <%= check_box_tag "ids[]", role.id, @roles.include?(role) %>
              <%= role.name %>
            </label>
          <% end %>
        </fieldset>
        <p>
          <%= submit_tag l(:button_apply), :name => nil %>
          <%= link_to l(:button_clear), permissions_roles_path, :class => 'icon icon-reload' %>
        </p>
      <% end %>
    </div>
  </fieldset>
</div>

<%= form_tag(permissions_roles_path, :id => 'permissions_form') do %>
<% @roles.each do |role| %>
    <%= hidden_field_tag "permissions[#{role.id}][]", '', :id => nil %>
<% end %>
<div class="autoscroll">
<table class="list permissions">
  <thead>
      <tr>
      <th style="width:680px;"><%=l(:label_general_data)%></th>
      <% @roles.each do |role| %>
      <th>
          <%= content_tag(role.builtin? ? 'em' : 'span', role.name) %>
      </th>
      <% end %>
      </tr>
  </thead>
  <tbody>
    <tr class="assignable">
      <td class="name">
          <%= link_to_function('',
                               "toggleCheckboxesBySelector('.assignable input')",
                               :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                               :class => 'icon-only icon-checked') %>
         <%=l(:field_assignable)%>
      </td>
      <% @roles.each do |role| %>
        <td title="<%= l(:field_assignable) + " (#{role.name})" %>">
          <%= check_box_tag "assignable[#{role.id}][]", 1, (role.assignable), :id => nil, :class => "role-#{role.id}" %>
        </td>
      <% end %>
    </tr>
    <tr class="group open">
      <td>
        <span class="expander icon icon-expended" onclick="toggleRowGroup(this);">&nbsp;</span>
        <%=l(:field_issues_visibility)%>
      </td>
      <% @roles.each do |role| %>
      <td class="role"></td>
      <% end %>
    </tr>
    <tr class="visibility_all">
      <td class="name">
        <%= link_to_function('',
                             "toggleCheckboxesBySelector('.visibility_all input')",
                             :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                             :class => 'icon-only icon-checked') %>
        <%=l(:label_issues_visibility_all)%>
      </td>
      <% @roles.each do |role| %>
      <td>
        <% unless role.anonymous? %>
          <label class="block">
            <%= radio_button_tag "issues_visibility[#{role.id}]", "all", role.issues_visibility == "all"
                   %>
          </label>
        <% end %>
      </td>
      <% end %>
    </tr>
    <tr class="visibility_public">
      <td class="name">
        <%= link_to_function('',
                             "toggleCheckboxesBySelector('.visibility_public input')",
                             :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                             :class => 'icon-only icon-checked') %>
        <%=l(:label_issues_visibility_public)%>
      </td>
      <% @roles.each do |role| %>
      <td>
        <% unless role.anonymous? %>
          <label class="block">
            <%= radio_button_tag "issues_visibility[#{role.id}]", "default", role.issues_visibility == "default"
                  %>

          </label>
        <% end %>
      </td>
      <% end %>
    </tr>
    <tr class="visibility_own">
      <td class="name">
        <%= link_to_function('',
                             "toggleCheckboxesBySelector('.visibility_own input')",
                             :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                             :class => 'icon-only icon-checked') %>
        <%=l(:label_issues_visibility_own)%>
      </td>
      <% @roles.each do |role| %>
      <td>
        <% unless role.anonymous? %>
          <label class="block">
            <%= radio_button_tag "issues_visibility[#{role.id}]", "own", role.issues_visibility == "own"
                  %>

          </label>
        <% end %>
      </td>
      <% end %>
    </tr>
  </tbody>
</table>
</div>
<div class="autoscroll">
<table class="list permissions">
<thead>
    <tr>
    <th><%=l(:label_permissions)%></th>
    <% @roles.each do |role| %>
    <th>
        <%= link_to_function('',
                             "toggleCheckboxesBySelector('input.role-#{role.id}')",
                             :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                             :class => 'icon-only icon-checked') %>
        <%= content_tag(role.builtin? ? 'em' : 'span', role.name) %>
    </th>
    <% end %>
    </tr>
</thead>
<tbody>
<% perms_by_module = @permissions.group_by {|p| p.project_module.to_s} %>
<% perms_by_module.keys.sort.each do |mod| %>
    <% unless mod.blank? %>
        <tr class="group open">
          <td>
            <span class="expander icon icon-expended" onclick="toggleRowGroup(this);">&nbsp;</span>
            <%= l_or_humanize(mod, :prefix => 'project_module_') %>
          </td>
          <% @roles.each do |role| %>
          <td class="role"><%= role.name %></td>
          <% end %>
        </tr>
    <% end %>
    <% perms_by_module[mod].each do |permission| %>
        <% humanized_perm_name = l_or_humanize(permission.name, :prefix => 'permission_') %>
        <tr class="permission-<%= permission.name %>">
        <td class="name">
            <%= link_to_function('',
                                 "toggleCheckboxesBySelector('.permission-#{permission.name} input')",
                                 :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                                 :class => 'icon-only icon-checked') %>
            <%= humanized_perm_name %>
        </td>
        <% @roles.each do |role| %>
          <% if role.setable_permissions.include? permission %>
            <td title="<%= "#{humanized_perm_name} (#{role.name})" %>">
              <%= check_box_tag "permissions[#{role.id}][]", permission.name, (role.permissions.include? permission.name), :id => nil, :class => "role-#{role.id}" %>
            </td>
          <% else %>
            <td></td>
          <% end %>
        <% end %>
        </tr>
    <% end %>
<% end %>
<% permissions = [:view_issues, :add_issues, :edit_issues, :add_issue_notes, :delete_issues] %>
  <tr class="group open">
    <td>
      <span class="expander icon icon-expended" onclick="toggleRowGroup(this);">&nbsp;</span>
      <%= l(:label_tracker_all) %>
    </td>
    <% @roles.each do |role| %>
      <td class="role"><%= role.name %></td>
    <% end %>
  </tr>
<% permissions.each do |permission| %>
  <tr class="all-trackers-<%= permission%>">
    <td class="name">
        <%= link_to_function('',
                             "toggleCheckboxesBySelector('tr.all-trackers-#{permission} input[type=checkbox]')",
                             :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                             :class => 'icon-only icon-checked') %>
        <%= l("permission_#{permission}") %>
    </td>
    <% @roles.each do |role| %>
      <% if role.setable_permissions.collect(&:name).include? permission %>
        <td title="<%= l("permission_#{permission}") + "(#{role.name})" %>">
          <%= hidden_field_tag "permissions_all_trackers[#{role.id}][#{permission}]", '0', :id => nil %>
          <%= check_box_tag "permissions_all_trackers[#{role.id}][#{permission}]", '1', (role.permissions_all_trackers?(permission)), :id => nil, :class => "role-#{role.id}", :data => {:disables => ".#{permission}_tracker_role_#{role.id}"} %>
        </td>
        <% else %>
        <td></td>
      <% end %>
      <%= hidden_field_tag "permissions_tracker_ids[#{role.id}][#{permission}][]", '' %>
    <% end %>
  </tr>
<% end %>
<% Tracker.sorted.all.each do |tracker| %>
<tr class="group open">
  <td>
    <span class="expander icon icon-expended" onclick="toggleRowGroup(this);">&nbsp;</span>
    <%= tracker.name %>
  </td>
  <% @roles.each do |role| %>
    <td class="role"><%= role.name %></td>
  <% end %>
</tr>
  <% permissions.each do |permission| %>
    <tr class="permission-<%= permission%><%= tracker.id%>">
      <td class="name">
          <%= link_to_function('',
                               "toggleCheckboxesBySelector('.permission-#{permission}#{tracker.id} input:enabled')",
                               :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}",
                               :class => 'icon-only icon-checked') %>
          <%= l("permission_#{permission}") %>
      </td>
      <% @roles.each do |role| %>
        <% if role.setable_permissions.collect(&:name).include? permission %>
          <td title="<%= l("permission_#{permission}") + "(#{role.name})" %>">
            <%= check_box_tag "permissions_tracker_ids[#{role.id}][#{permission}][]", tracker.id, (role.permissions_tracker_ids[permission].include? tracker.id.to_s), :id => "role_permissions_tracker_ids-#{role.id}_#{tracker.id}", :class => "#{permission}_tracker_role_#{role.id}" %>

          </td>
          <% else %>
          <td></td>
        <% end %>
      <% end %>
    </tr>
  <% end %>
<% end %>
</tbody>
</table>
</div>
<p><%= check_all_links 'permissions_form' %></p>
<p><%= submit_tag l(:button_save) %></p>
<% end %>
<% other_formats_links do |f| %>
  <%= f.link_to_with_query_parameters 'CSV', {}, :onclick => "showModal('csv-export-options', '330px'); return false;" %>
<% end %>
<div id="csv-export-options" style="display: none;">
  <h3 class="title"><%= l(:label_export_options, :export_format => 'CSV') %></h3>
  <%= form_tag(permissions_roles_path(:format => 'csv'), :method => :get, :id => 'csv-export-form') do %>
  <%= export_csv_encoding_select_tag %>
  <p class="buttons">
    <%= submit_tag l(:button_export), :name => nil, :onclick => 'hideModal(this);', :data => {:disable_with => false} %>
    <%= link_to_function l(:button_cancel), 'hideModal(this);' %>
  </p>
  <% end %>
</div>
